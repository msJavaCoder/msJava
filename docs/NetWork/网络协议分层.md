# 网络协议分层

> 国际标准化组织 ISO 提出了 OSI 开放互连的七层计算机网络模型，从上到下分别是应用层、表示层、会
> 话层、运输层、网络层、链路层和物理层。OSI 模型的概念清楚，理论也比较完善，但是既复杂又不实
> 用。还有一种是 TCP/IP 体系结构，它分为四层，从上到下分别是应用层、运输层、网际层和网络接口
> 层，不过从实质上将只有三层，因为最下面的网络接口层并没有什么具体内容。因特网的协议栈使用一
> 种五层的模型结构，从上到下依次是应用层、运输层、网络层、链路层和物理层，其中下层是为上层提
> 供服务的，每层执行某些动作或使用下层的服务来提高服务。

## 应用层

应用层是网络体系结构中的最高层，应用层的任务就是通过应用进程之间的交互来完成特定网络应用，
这一层的数据单元叫做报文。
应用层的协议定义了应用进程之间通信和交互的规则，主要包括了域名系统 DNS、支持万维网的 HTTP
协议、支持电子邮件的 SMTP 协议、文件传输协议 FTP 等。

### **域名解析系统 DNS**

DNS 被设计为一个联机分布式数据库系统，并采用客户服务器方式。DNS 使大多数名字都在本地进行
解析，仅少量解析需要在互联网上通信，因此 DNS 的效率很高。由于 DNS 是分布式系统，即使单个计
算机出现了故障也不会妨碍到整个 DNS 系统的正常运行。
**主机向本地域名服务器的查询一般都采用递归查询**，递归查询指如果主机所询问的本地域名服务器不知
道被查询域名的 IP 地址，那么本地域名服务器就以 DNS 客户的身份向其他根域名服务器继续发出查询
请求报文。递归查询的结果是要查询的 IP 地址，或者是报错，表示无法查询到所需的 IP 地址。
**本地域名服务器向根域名服务器查询通常采用迭代查询**，迭代查询指当根域名服务器收到本地域名服务
器发出的迭代查询请求报文时，要么给出所要查询的 IP 地址，要么告诉它该向哪一个域名服务器进行
查询。本地域名服务器也可以采用递归查询，这取决于最初的查询请求报文设置的查询方式。

### **文件传送协议 FTP**

FTP 使用 TCP 可靠的运输服务，FTP 使用客户服务器方式，一个 FTP 服务器进程可以同时为多个客户
进程提供服务，在进行文件传输时，FTP 的客户和服务器之间要建立两个并行的 TCP 连接：控制连接和
数据连接，实际用于传输文件的是数据连接。

### **电子邮件系统协议 SMTP/POP3/IMAP**

一个电子邮件系统有三个主要组成构件，即用户代理、邮件服务器、以及邮件协议。
从用户代理把邮件传送到邮件服务器，以及在邮件服务器之间的传送都要使用 SMTP，但用户代理从邮
件服务器读取邮件时则要使用 POP3 或 IMAP 协议。
基于万维网的电子邮件使用户可以利用浏览器收发电子邮件，用户浏览器和邮件服务器之间使用 HTTP
协议，而邮件服务器之间的传送仍然使用 SMTP 协议。

## 运输层

**运输层的任务就是负责向两台主机中进程之间的通信提供通用的数据传输服务**，应用进程利用该服务来
传送应用层报文。由于一台主机同时可以运行多个进程，因此运输层具有复用和分用的功能，复用就是
多个应用层进程可以同时使用下面运输层的服务，分用就是把运输层收到的信息分别交付给上面应用层
中的对应进程。
运输层主要使用两种协议：① 用户数据报协议 UDP，这是一种提供无连接的、尽最大努力交付的数据
传输服务，不保证数据传输的可靠性，数据传输单位是用户数据报。② 传输控制协议 TCP，这是一种面
向连接的、可靠的数据传输服务，数据传输单元是报文。

## 网络层

**网络层负责为分组交换网上的不同主机提供通信服务**，在发生数据时，网络层把数据层产生的报文或用
户数据报封装成分组进行传送，由于网络层使用 IP 协议，因此分组也叫 IP 数据报。网络层的另一个任
务就是选择合适的路由，使源主机运输层所传下来的分组能够通过网络中的路由器找到目的主机。
网络层的协议包括了网际协议 IP、地址解析协议 ARP、网际控制报文协议 ICMP 以及路由选择协议
RIP/OSPF/BGP-4 等。

### **网际协议 IP**

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一，一般指的是 IPv4。与 IP 协议配套使用的协议还
有 ARP、ICMP 和 IGMP，IP 使用 ARP，ICMP 和 IGMP 要使用 IP。由于网际协议 IP 是用来使互连起来
的许多计算机网络能够进行通信的，因此 TCP/IP 体系中的网络层也称网际层或 IP 层。要解决 IP 地址
耗尽的问题，根本方法是采用具有更大地址空间的新版本 IP 协议即 IPv6，向 IPv6 过渡可以使用双协议
栈或使用隧道技术。

### **地址解析协议 ARP**

由于 IP 协议使用了 ARP 协议，因此把 ARP 协议归到网络层，但 ARP 的作用是通过一个 ARP 高速缓存
存储本地局域网的各主机和路由器的 IP 地址到硬件地址的映射表，以从网络层的 IP 地址解析出在数据
链路层使用的硬件地址，因此也可以把 ARP 划归在数据链路层。与 ARP 对应的协议是 RARP，逆地址
解析协议，作用是使只知道自己硬件地址的主机能够找出 IP 地址，但被 DHCP 协议取代。

### **路由选择协议 RIP/OSPF/BGP-4**

路由选择协议有两大类：内部网关协议，如 RIP 和 OSPF；外部网关协议，如 BGP-4。
RIP 是分布式的基于距离向量的路由选择协议，只适用于小型互联网。RIP 按照固定的时间间隔与相邻
路由器交换信息，交换的信息是当前路由表。OSPF 是分布式的链路状态协议，适用于大型互联网，只
在链路状态发生变化时才向本自治系统中的所有路由器用洪泛法发送与本路由器相邻的所有路由器的链
路状态信息。
BGP-4 是不同自治系统的路由器之间交换路由信息的协议，是一种路径向量路由选择协议。其目标是寻
找一条能够到达目的网络且比较好的路由而不是最佳路由。

### 网际控制报文协议 ICMP

ICMP 报文作为 IP 数据报的数据，加上首部后组成 IP 数据报发送出去，使用 ICMP 并非为了实现可靠
传输，ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。ICMP 报文的种类有两种，
即 ICMP 差错报告报文和 ICMP 询问报文。
ICMP 的一个重要应用就是分组间探测 PING，用来测试两台主机之间的连通性，PING 使用了 ICMP 回
送请求与回送回答报文。

### 网际组管理协议 IGMP

IP 多播使用 IGMP 协议，IGMP 并非在互联网范围内对所有多播组成员进行管理，它不知道 IP 多播组
包含的成员个数也不知道这些成员都分布在哪些网络上。
IGMP 协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机上的某个进程参加或推出
了某个多播组。

## 链路层

**数据链路层的任务是将网络层交下来的 IP 数据报组装成帧，在两个相邻结点之间的链路上传输帧，每**
**一帧包括数据和必要的控制信息（同步信息、地址信息、差错控制等）**。在接收数据时，控制信息使接
收端能够知道一个帧从哪个比特开始到哪个比特结束，这样链路层就可以从帧中提取出数据部分上交给
网络层。控制信息还使接收端能够检测到所收到的帧有无差错，如果有差错就简单地丢弃这个帧以免继
续传送而浪费网络资源。
数据链路层的协议包括了点对点协议 PPP 和 CSMA/CD 协议等。

### 点对点协议 PPP

在通信线路质量较差的年代，使用高级数据链路控制 HDLC 作为实现可靠传输的数据链路层协议，但现
在 HDLC 已经很少使用了，对于点对点的链路，简单得多的点对点协议 PPP 是目前使用得最广泛的数
据链路层协议。PPP 协议的特点是简单、只检测差错而不纠正差错、不使用序号也不进行流量控制、可
同时支持多种网络层协议。

### CSMA/CD 协议

以太网采用的是具有冲突检测的载波监听多点接入 CSMA/CD 协议，协议的要点是：发送前先监听、边
发送边监听，一旦发现总线上出现了碰撞就立即停止发送。然后按照退避算法等待一段随机时间后再次
发送，因此每一个站在自己发送数据之后的一小段时间内存在遭遇碰撞的可能性。以太网上各站点都平
等地争用以太网信道。

## 物理层

**物理层的任务是尽可能地屏蔽掉传输媒体和通信手段的差异，使物理层上面的数据链路层感觉不到这些**
**差异，使其只需考虑本层的协议和服务。**
物理层所传输的数据单位是比特，发送方发送 1 或 0，接收方也接收 1 或 0，因此物理层需要考虑用多
大的电压代表 1 或 0，以及接收方如何识别出发送方所发送的比特。除此之外，物理层还要确定连接电
缆的插头应当有多少根引以及各引脚如何连接等问题。