# 理解TCP和UDP

## 1. TCP是什么

> TCP（Transmission Control Protocol，传输控制协议）是一个面向连接的、可靠的、基于字节流的传输层协议。从它的概念中我们可以看出 TCP 的三个特点：面向连接、可靠性和面向字节流。

**TCP 的特点**

**面向连接**：是指 TCP 是面向客户端和服务器端连接的通讯协议，使用它可以将客户端和服务器端进行连接。

**可靠性**：是指无论网络环境多差，TCP 都可以保证信息一定能够传递到接收端。

TCP 之所以可以保证可靠性主要得益于两个方面，一个是“状态性”，另一个是“可控制性”。所谓状态性是指 TCP 会记录信息的发送状态，例如，哪些数据收到了、哪些数据没收到等状态信息都会被记录；可控制性是指 TCP 会根据状态情况控制自己的行为，比如当 TCP 意识到丢包了就会控制重发此包，这样就实现了 TCP 的可靠性。

**面向字节流**：是指 TCP 是以字节流的方式进行数据传输的。

**TCP 是传输层协议，对应 OSI 网络模型的第四层传输层，特点如下。**

- TCP 协议是基于链接的，也就是传输数据前需要先建立好链接，然后再进行传输。

- TCP 链接一旦建立，就可以在链接上进行双向的通信。

- TCP 的传输是基于字节流而不是报文，将数据按字节大小进行编号，接收端通过 ACK 来确认收到的数据编号，通过这种机制，TCP 协议能够保证接收数据的有序性和完整性，因此 TCP 能够提供可靠性传输。

- TCP 还能提供流量控制能力，通过滑动窗口来控制数据的发送速率。滑动窗口的本质是动态缓冲区，接收端根据自己的处理能力，在 TCP 的 Header 中动态调整窗口大小，通过 ACK 应答包通知给发送端，发送端根据窗口大小调整发送的的速度。

- 仅仅有了流量控制能力还不够，TCP 协议还考虑到了网络问题可能会导致大量重传，进而导致网络情况进一步恶化，因此 TCP 协议还提供拥塞控制。TCP 处理拥塞控制主要用到了慢启动、拥塞避免、拥塞发生、快速恢复四个算法，感兴趣的同学可以进一步了解。

## 2. TCP三次握手与四次挥手

 TCP 三次握手的执行流程，如下图所示：

<img src="https://img02.sogoucdn.com/app/a/100520146/dd6df6154e259897c25d924cacd8cffe" alt="img"  />

TCP 三次握手的执行流程图

关键字说明：

**SYN（Synchronize Sequence Numbers），同步序列编号；**

**ACK（Acknowledge Character），确认字符；**

**SEQ（Sequence Number），序列号。**

TCP 的三次握手执行流程如下：

- 最开始时客户端和服务端都处于 CLOSED 状态，然后服务端先主动监听某个端口，此时服务器端就变成了 LISTEN（监听）状态；
- 然后客户端主动发起连接，发送 SYN（同步序列编号），此时客户端就变成了 SYN-SENT 状态；
- 服务端接收到信息之后返回 SYN 和 ACK 至客户端，此时服务器端就变成了 SYN-REVD 状态；
- 客户端接收到消息之后，再发送 ACK 至服务器端，此时客户端就变成了 ESTABLISHED（已确认）状态，服务端收到 ACK 之后，也变成了 ESTABLISHED 状态，此时连接工作就执行完了。

 TCP 四次挥手的执行流程，如下图所示：

![img](https://img01.sogoucdn.com/app/a/100520146/7bacaab50092f15af650aa33c70d81fb)

TCP 的四次挥手执行流程如下：

- TCP 链接的关闭，通信双方都可以先发起，我们暂且把先发起的一方看作 Client，从图中看出，通信中 Client 和 Server 两端的链接都是 ESTABLISHED 状态，然后 Client 先主动发起了关闭链接请求，Client 向 Server 发送了一个 FIN 包，表示 Client 端已经没有数据要发送了，然后 Client 进入了 FIN_WAIT_1 状态。

-  Server 端收到 FIN 后，返回 ACK，然后进入 CLOSE_WAIT 状态。此时 Server 属于半关闭状态，因为此时 Client 向 Server 方向已经不会发送数据了，可是 Server 向 Client 端可能还有数据要发送。

-  当 Server 端数据发送完毕后，Server 端会向 Client 端发送 FIN，表示 Server 端也没有数据要发送了，此时 Server 进入 LAST_ACK 状态，就等待 Client 的应答就可以关闭链接了。

-  Client 端收到 Server 端的 FIN 后，回复 ACK，然后进入 TIME_WAIT 状态。TIME_WAIT 状态下需要等待 2 倍的最大报文段生存时间，来保证链接的可靠关闭，之后才会进入 CLOSED 关闭状态。而 Server 端收到 ACK 后直接就进入 CLOSED 状态。


## 3.为什么TCP需要三次握手呢？

- **原因一：防止重复连接**

**三次握手的主要原因是为了防止旧的重复连接引起连接混乱问题。**

比如在网络状况比较复杂或者网络状况比较差的情况下，发送方可能会连续发送多次建立连接的请求。如果 TCP 握手的次数只有两次，那么接收方只能选择接受请求或者拒绝接受请求，但它并不清楚这次的请求是正常的请求，还是由于网络环境问题而导致的过期请求，如果是过期请求的话就会造成错误的连接。

所以如果 TCP 是三次握手的话，那么客户端在接收到服务器端 SEQ+1 的消息之后，就可以判断当前的连接是否为历史连接，如果判断为历史连接的话就会发送终止报文（RST）给服务器端终止连接；如果判断当前连接不是历史连接的话就会发送指令给服务器端来建立连接。

- **原因二：同步初始化序列化**

通过上面的概念我们知道 TCP 的一个重要特征就是可靠性，而 TCP 为了保证在不稳定的网络环境中构建一个稳定的数据连接，它就需要一个“序列号”字段来保证自己的稳定性，而这个序列号的作用就是防止数据包重复发送，以及有效的解决数据包接收时顺序颠倒的问题。

那么在**建立 TCP 连接时就需要同步初始化一个序列号来保证 TCP 的稳定性**，因此它需要执行以下过程：

1. 首先客户端发送一个携带了初始序列号的 SYN 报文给服务器端；
2. 服务端接收到消息之后会回复一个 ACK 的应答报文，表示客户端的 SYN 报文已被服务端成功接收了；
3. 而客户端收到消息之后也会发送一个 ACK 给服务端，服务器端拿到这个消息之后，我们就可以得到一个可靠的初始化序列号了。
4. 而如果是两次握手的话，就无法进行序列号的确认工作了，因此也就无法得到一个可靠的序列号了，所以 TCP 连接至少需要三次握手。
5. 以上两种原因就是 TCP 连接为什么需要三次握手的主要原因，当然 TCP 连接还可以四次握手，甚至是五次握手，也能实现 TCP 连接的稳定性，但三次握手是最节省资源的连接方式，因此 TCP 连接应该为三次握手。

## 4. 为什么需要等待 2 倍最大报文段生存时间之后再关闭链接？

1. 保证 TCP 协议的全双工连接能够可靠关闭；

2. 保证这次连接的重复数据段从网络中消失，防止端口被重用时可能产生数据混淆。

## 5. UDP是什么？

> UDP（User Data Protocol，用户数据报协议）是无连接的、简单的、面向数据报的传输层协议。也就是 UDP 在发送数据之前，无须建立客户端与服务端的连接，直接发送消息即可。

UDP 常见的使用场景有：语音、视频等多媒体通信、DNS（域名转化）、TFTP 等。

**TCP 和 UDP 的区别主要体现在以下 7 个方面：**

1. 可靠性，TCP 有“状态性”和“可控制性”可以保证消息不重复、按顺序、不丢失的发送和接收，而 UDP 则不能保证消息的可靠性；

2. 连接，TCP 是面向连接的传输层协议，传输数据前先要建立连接，而 UDP 发送数据之前无需建立连接；

3. 服务对象，TCP 服务的对象为一对一的双端应用，而 UDP 可以应用于一对一、一对多和多对多的通信场景；

4. 效率TCP 和 UDP 的使用场景如下图所示：，TCP 的传输效率较低，而 UDP 的传输效率较高；

5. 流量控制，TCP 有滑动窗口可以用来控制流量，而 UDP 则不具备流量控制的能力；

6. 报文，TCP 是面向字节流的传输层协议，而 UDP 是面向报文的传输层协议；

7. 应用场景，TCP 的应用场景是对消息准确性和顺序要求较高的场景，而 UDP 则是应用于对通信效率较高、准确性要求相对较低的场景。

TCP 和 UDP 的使用场景如下图所示：

|   使用场景    |     应用层协议      | 传输层协议 |
| :-----------: | :-----------------: | :--------: |
| 浏览器/万维网 |     HTPP/HTTPS      |    TCP     |
|   文件传输    |         FTP         |    TCP     |
|   电子邮件    |        SMTP         |    TCP     |
| 音、视频通讯  | RTP（实时传输协议） |    UDP     |
|   域名转化    |         DNS         |    UDP     |
|   网格管理    |        SNMP         |    UDP     |

## 总结

上文我们介绍了 **TCP 三个特点：面向连接、可靠性和面向字节流**，其中可靠性主要是依赖它的状态记录和根据实际情况调整自身的行为方式。例如，当 TCP 意识到丢包时就会重发此包，这样就保证了通信的可靠性。在传输效率要求比较高且对可靠性要求不高的情况下可以使用 UDP，反之则应该使用 TCP。

**TCP 之所以需要三次握手的主要原因是为了防止在网络环境比较差的情况下不会进行无效的连接，同时三次握手可以实现 TCP 初始化序列号的确认工作，TCP 需要初始化一个序列号来保证消息的顺序。如果是两次握手则不能确认序列号是否正常，如果是四次握手的话会浪费系统的资源，因此 TCP 三次握手是最优的解决方案，所以 TCP 连接需要三次握手。**

