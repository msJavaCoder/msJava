# ğŸ‘‰ LinkedHashMapæºç åˆ†æ

HashMap æ˜¯æ— åºçš„ï¼ŒTreeMap å¯ä»¥æŒ‰ç…§ key è¿›è¡Œæ’åºï¼Œé‚£æœ‰æœ¨æœ‰ Map æ˜¯å¯ä»¥ç»´æŠ¤æ’å…¥çš„é¡ºåºçš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ä¸‹ LinkedHashMapã€‚

LinkedHashMap æœ¬èº«æ˜¯ç»§æ‰¿ HashMap çš„ï¼Œæ‰€ä»¥å®ƒæ‹¥æœ‰ HashMap çš„æ‰€æœ‰ç‰¹æ€§ï¼Œå†æ­¤åŸºç¡€ä¸Šï¼Œè¿˜æä¾›äº†ä¸¤å¤§ç‰¹æ€§ï¼š

- æŒ‰ç…§æ’å…¥é¡ºåºè¿›è¡Œè®¿é—®ï¼›
- å®ç°äº†è®¿é—®æœ€å°‘æœ€å…ˆåˆ é™¤åŠŸèƒ½ï¼Œå…¶ç›®çš„æ˜¯æŠŠå¾ˆä¹…éƒ½æ²¡æœ‰è®¿é—®çš„ key è‡ªåŠ¨åˆ é™¤ã€‚

æ¥ç€æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸Šè¿°ä¸¤å¤§ç‰¹æ€§ã€‚

## 1 æŒ‰ç…§æ’å…¥é¡ºåºè®¿é—®

### 1.1 LinkedHashMap é“¾è¡¨ç»“æ„

æˆ‘ä»¬çœ‹ä¸‹ LinkedHashMap æ–°å¢äº†å“ªäº›å±æ€§ï¼Œä»¥è¾¾åˆ°äº†é“¾è¡¨ç»“æ„çš„ï¼š

```java
// é“¾è¡¨å¤´
transient LinkedHashMap.Entry<K,V> head;

// é“¾è¡¨å°¾
transient LinkedHashMap.Entry<K,V> tail;

// ç»§æ‰¿ Nodeï¼Œä¸ºæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å¢åŠ äº† before å’Œ after å±æ€§
static class Entry<K,V> extends HashMap.Node<K,V> {
    Entry<K,V> before, after;
    Entry(int hash, K key, V value, Node<K,V> next) {
        super(hash, key, value, next);
    }
}

// æ§åˆ¶ä¸¤ç§è®¿é—®æ¨¡å¼çš„å­—æ®µï¼Œé»˜è®¤ false
// true æŒ‰ç…§è®¿é—®é¡ºåºï¼Œä¼šæŠŠç»å¸¸è®¿é—®çš„ key æ”¾åˆ°é˜Ÿå°¾
// false æŒ‰ç…§æ’å…¥é¡ºåºæä¾›è®¿é—®
final boolean accessOrder;
```

ä»ä¸Šè¿° Map æ–°å¢çš„å±æ€§å¯ä»¥çœ‹åˆ°ï¼ŒLinkedHashMap çš„æ•°æ®ç»“æ„å¾ˆåƒæ˜¯æŠŠ LinkedList çš„æ¯ä¸ªå…ƒç´ æ¢æˆäº† HashMap çš„ Nodeï¼Œåƒæ˜¯ä¸¤è€…çš„ç»“åˆä½“ï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºå¢åŠ äº†è¿™äº›ç»“æ„ï¼Œä»è€Œèƒ½æŠŠ Map çš„å…ƒç´ éƒ½ä¸²è”èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œè€Œé“¾è¡¨å°±å¯ä»¥ä¿è¯é¡ºåºäº†ï¼Œå°±å¯ä»¥ç»´æŠ¤å…ƒç´ æ’å…¥è¿›æ¥çš„é¡ºåºã€‚

### 1.2 å¦‚ä½•æŒ‰ç…§é¡ºåºæ–°å¢

LinkedHashMap åˆå§‹åŒ–æ—¶ï¼Œé»˜è®¤ accessOrder ä¸º falseï¼Œå°±æ˜¯ä¼šæŒ‰ç…§æ’å…¥é¡ºåºæä¾›è®¿é—®ï¼Œæ’å…¥æ–¹æ³•ä½¿ç”¨çš„æ˜¯çˆ¶ç±» HashMap çš„ put æ–¹æ³•ï¼Œä¸è¿‡è¦†å†™äº† put æ–¹æ³•æ‰§è¡Œä¸­è°ƒç”¨çš„ newNode/newTreeNode å’Œ afterNodeAccess æ–¹æ³•ã€‚

newNode/newTreeNode æ–¹æ³•ï¼Œæ§åˆ¶æ–°å¢èŠ‚ç‚¹è¿½åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·æ¯æ¬¡æ–°èŠ‚ç‚¹éƒ½è¿½åŠ åˆ°å°¾éƒ¨ï¼Œå³å¯ä¿è¯æ’å…¥é¡ºåºäº†ï¼Œæˆ‘ä»¬ä»¥ newNode æºç ä¸ºä¾‹ï¼š

```java
// æ–°å¢èŠ‚ç‚¹ï¼Œå¹¶è¿½åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨
Node<K,V> newNode(int hash, K key, V value, Node<K,V> e) {
    // æ–°å¢èŠ‚ç‚¹
    LinkedHashMap.Entry<K,V> p =
        new LinkedHashMap.Entry<K,V>(hash, key, value, e);
    // è¿½åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨
    linkNodeLast(p);
    return p;
}
// link at the end of list
private void linkNodeLast(LinkedHashMap.Entry<K,V> p) {
    LinkedHashMap.Entry<K,V> last = tail;
    // æ–°å¢èŠ‚ç‚¹ç­‰äºä½èŠ‚ç‚¹
    tail = p;
    // last ä¸ºç©ºï¼Œè¯´æ˜é“¾è¡¨ä¸ºç©ºï¼Œé¦–å°¾èŠ‚ç‚¹ç›¸ç­‰
    if (last == null)
        head = p;
    // é“¾è¡¨æœ‰æ•°æ®ï¼Œç›´æ¥å»ºç«‹æ–°å¢èŠ‚ç‚¹å’Œä¸Šä¸ªå°¾èŠ‚ç‚¹ä¹‹é—´çš„å‰åå…³ç³»å³å¯
    else {
        p.before = last;
        last.after = p;
    }
}
```

LinkedHashMap é€šè¿‡æ–°å¢å¤´èŠ‚ç‚¹ã€å°¾èŠ‚ç‚¹ï¼Œç»™æ¯ä¸ªèŠ‚ç‚¹å¢åŠ  beforeã€after å±æ€§ï¼Œæ¯æ¬¡æ–°å¢æ—¶ï¼Œéƒ½æŠŠèŠ‚ç‚¹è¿½åŠ åˆ°å°¾èŠ‚ç‚¹ç­‰æ‰‹æ®µï¼Œåœ¨æ–°å¢çš„æ—¶å€™ï¼Œå°±å·²ç»ç»´æŠ¤äº†æŒ‰ç…§æ’å…¥é¡ºåºçš„é“¾è¡¨ç»“æ„äº†ã€‚

### 1.3 æŒ‰ç…§é¡ºåºè®¿é—®

LinkedHashMap åªæä¾›äº†å•å‘è®¿é—®ï¼Œå³æŒ‰ç…§æ’å…¥çš„é¡ºåºä»å¤´åˆ°å°¾è¿›è¡Œè®¿é—®ï¼Œä¸èƒ½åƒ LinkedList é‚£æ ·å¯ä»¥åŒå‘è®¿é—®ã€‚

æˆ‘ä»¬ä¸»è¦é€šè¿‡è¿­ä»£å™¨è¿›è¡Œè®¿é—®ï¼Œè¿­ä»£å™¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé»˜è®¤ä»å¤´èŠ‚ç‚¹å¼€å§‹è®¿é—®ï¼Œåœ¨è¿­ä»£çš„è¿‡ç¨‹ä¸­ï¼Œä¸æ–­è®¿é—®å½“å‰èŠ‚ç‚¹çš„ after èŠ‚ç‚¹å³å¯ã€‚

Map å¯¹ keyã€value å’Œ entityï¼ˆèŠ‚ç‚¹ï¼‰ éƒ½æä¾›å‡ºäº†è¿­ä»£çš„æ–¹æ³•ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦è¿­ä»£ entityï¼Œå°±å¯ä½¿ç”¨ `LinkedHashMap.entrySet().iterator()` è¿™ç§å†™æ³•ç›´æ¥è¿”å› LinkedHashIterator ï¼ŒLinkedHashIterator æ˜¯è¿­ä»£å™¨ï¼Œæˆ‘ä»¬è°ƒç”¨è¿­ä»£å™¨çš„ nextNode æ–¹æ³•å°±å¯ä»¥å¾—åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿­ä»£å™¨çš„æºç å¦‚ä¸‹ï¼š

```java
// åˆå§‹åŒ–æ—¶ï¼Œé»˜è®¤ä»å¤´èŠ‚ç‚¹å¼€å§‹è®¿é—®
LinkedHashIterator() {
    // å¤´èŠ‚ç‚¹ä½œä¸ºç¬¬ä¸€ä¸ªè®¿é—®çš„èŠ‚ç‚¹
    next = head;
    expectedModCount = modCount;
    current = null;
}

final LinkedHashMap.Entry<K,V> nextNode() {
    LinkedHashMap.Entry<K,V> e = next;
    if (modCount != expectedModCount)// æ ¡éªŒ
        throw new ConcurrentModificationException();
    if (e == null)
        throw new NoSuchElementException();
    current = e;
    next = e.after; // é€šè¿‡é“¾è¡¨çš„ after ç»“æ„ï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªè¿­ä»£çš„èŠ‚ç‚¹
    return e;
}
```

åœ¨æ–°å¢èŠ‚ç‚¹æ—¶ï¼Œæˆ‘ä»¬å°±å·²ç»ç»´æŠ¤äº†å…ƒç´ ä¹‹é—´çš„æ’å…¥é¡ºåºäº†ï¼Œæ‰€ä»¥è¿­ä»£è®¿é—®æ—¶éå¸¸ç®€å•ï¼Œåªéœ€è¦ä¸æ–­çš„è®¿é—®å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å³å¯ã€‚

## 2 è®¿é—®æœ€å°‘åˆ é™¤ç­–ç•¥

### 2.1 ä¸¾ä¾‹ç†è§£

è¿™ç§ç­–ç•¥ä¹Ÿå«åš LRUï¼ˆLeast recently used,æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ï¼Œå¤§æ¦‚çš„æ„æ€å°±æ˜¯ç»å¸¸è®¿é—®çš„å…ƒç´ ä¼šè¢«è¿½åŠ åˆ°é˜Ÿå°¾ï¼Œè¿™æ ·ä¸ç»å¸¸è®¿é—®çš„æ•°æ®è‡ªç„¶å°±é è¿‘é˜Ÿå¤´ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®åˆ é™¤ç­–ç•¥ï¼Œæ¯”å¦‚å½“ Map å…ƒç´ ä¸ªæ•°å¤§äºå¤šå°‘æ—¶ï¼ŒæŠŠå¤´èŠ‚ç‚¹åˆ é™¤ï¼Œæˆ‘ä»¬å†™ä¸ª demo æ–¹ä¾¿å¤§å®¶ç†è§£ã€‚demo å¦‚ä¸‹ï¼Œå®Œæ•´ä»£ç å¯åˆ° github ä¸ŠæŸ¥çœ‹ï¼š

```java
public void testAccessOrder() {
  // æ–°å»º LinkedHashMap
  LinkedHashMap<Integer, Integer> map = new LinkedHashMap<Integer, Integer>(4,0.75f,true) {
    {
      put(10, 10);
      put(9, 9);
      put(20, 20);
      put(1, 1);
    }

    @Override
    // è¦†å†™äº†åˆ é™¤ç­–ç•¥çš„æ–¹æ³•ï¼Œæˆ‘ä»¬è®¾å®šå½“èŠ‚ç‚¹ä¸ªæ•°å¤§äº 3 æ—¶ï¼Œå°±å¼€å§‹åˆ é™¤å¤´èŠ‚ç‚¹
    protected boolean removeEldestEntry(Map.Entry<Integer, Integer> eldest) {
      return size() > 3;
    }
  };

  log.info("åˆå§‹åŒ–ï¼š{}",JSON.toJSONString(map));
  Assert.assertNotNull(map.get(9));
  log.info("map.get(9)ï¼š{}",JSON.toJSONString(map));
  Assert.assertNotNull(map.get(20));
  log.info("map.get(20)ï¼š{}",JSON.toJSONString(map));

}
```

æ‰“å°å‡ºæ¥çš„ç»“æœå¦‚ä¸‹ï¼š

```java
åˆå§‹åŒ–ï¼š{9:9,20:20,1:1}
map.get(9)ï¼š{20:20,1:1,9:9}
map.get(20)ï¼š{1:1,9:9,20:20}
```

å¯ä»¥çœ‹åˆ°ï¼Œmap åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ”¾è¿›å»å››ä¸ªå…ƒç´ ï¼Œä½†ç»“æœåªæœ‰ä¸‰ä¸ªå…ƒç´ ï¼Œ10 ä¸è§äº†ï¼Œè¿™ä¸ªä¸»è¦æ˜¯å› ä¸ºæˆ‘ä»¬è¦†å†™äº† removeEldestEntry æ–¹æ³•ï¼Œæˆ‘ä»¬å®ç°äº†å¦‚æœ map ä¸­å…ƒç´ ä¸ªæ•°å¤§äº 3 æ—¶ï¼Œæˆ‘ä»¬å°±æŠŠé˜Ÿå¤´çš„å…ƒç´ åˆ é™¤ï¼Œå½“ put(1, 1) æ‰§è¡Œçš„æ—¶å€™ï¼Œæ­£å¥½æŠŠé˜Ÿå¤´çš„ 10 åˆ é™¤ï¼Œè¿™ä¸ªä½“ç°äº†è¾¾åˆ°æˆ‘ä»¬è®¾å®šçš„åˆ é™¤ç­–ç•¥æ—¶ï¼Œä¼šè‡ªåŠ¨çš„åˆ é™¤å¤´èŠ‚ç‚¹ã€‚

å½“æˆ‘ä»¬è°ƒç”¨ map.get(9) æ–¹æ³•æ—¶ï¼Œå…ƒç´  9 ç§»åŠ¨åˆ°é˜Ÿå°¾ï¼Œè°ƒç”¨ map.get(20) æ–¹æ³•æ—¶ï¼Œ å…ƒç´  20 è¢«ç§»åŠ¨åˆ°é˜Ÿå°¾ï¼Œè¿™ä¸ªä½“ç°äº†ç»å¸¸è¢«è®¿é—®çš„èŠ‚ç‚¹ä¼šè¢«ç§»åŠ¨åˆ°é˜Ÿå°¾ã€‚

è¿™ä¸ªä¾‹å­å°±å¾ˆå¥½çš„è¯´æ˜äº†è®¿é—®æœ€å°‘åˆ é™¤ç­–ç•¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹åŸç†ã€‚

### 2.2 å…ƒç´ è¢«è½¬ç§»åˆ°é˜Ÿå°¾

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ä¸ºä»€ä¹ˆ get æ—¶ï¼Œå…ƒç´ ä¼šè¢«ç§»åŠ¨åˆ°é˜Ÿå°¾ï¼š

```java
public V get(Object key) {
    Node<K,V> e;
    // è°ƒç”¨ HashMap  get æ–¹æ³•
    if ((e = getNode(hash(key), key)) == null)
        return null;
    // å¦‚æœè®¾ç½®äº† LRU ç­–ç•¥
    if (accessOrder)
    // è¿™ä¸ªæ–¹æ³•æŠŠå½“å‰ key ç§»åŠ¨åˆ°é˜Ÿå°¾
        afterNodeAccess(e);
    return e.value;
}
```

ä»ä¸Šè¿°æºç ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ afterNodeAccess æ–¹æ³•æŠŠå½“å‰è®¿é—®èŠ‚ç‚¹ç§»åŠ¨åˆ°äº†é˜Ÿå°¾ï¼Œå…¶å®ä¸ä»…ä»…æ˜¯ get æ–¹æ³•ï¼Œæ‰§è¡Œ getOrDefaultã€computeã€computeIfAbsentã€computeIfPresentã€merge æ–¹æ³•æ—¶ï¼Œä¹Ÿä¼šè¿™ä¹ˆåšï¼Œé€šè¿‡ä¸æ–­çš„æŠŠç»å¸¸è®¿é—®çš„èŠ‚ç‚¹ç§»åŠ¨åˆ°é˜Ÿå°¾ï¼Œé‚£ä¹ˆé è¿‘é˜Ÿå¤´çš„èŠ‚ç‚¹ï¼Œè‡ªç„¶å°±æ˜¯å¾ˆå°‘è¢«è®¿é—®çš„å…ƒç´ äº†ã€‚

### 2.3 åˆ é™¤ç­–ç•¥

ä¸Šè¿° demo æˆ‘ä»¬åœ¨æ‰§è¡Œ put æ–¹æ³•æ—¶ï¼Œå‘ç°é˜Ÿå¤´å…ƒç´ è¢«åˆ é™¤äº†ï¼ŒLinkedHashMap æœ¬èº«æ˜¯æ²¡æœ‰ put æ–¹æ³•å®ç°çš„ï¼Œè°ƒç”¨çš„æ˜¯ HashMap çš„ put æ–¹æ³•ï¼Œä½† LinkedHashMap å®ç°äº† put æ–¹æ³•ä¸­çš„è°ƒç”¨ afterNodeInsertion æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹å¼å®ç°äº†åˆ é™¤ï¼Œæˆ‘ä»¬çœ‹ä¸‹æºç ï¼š

```java
// åˆ é™¤å¾ˆå°‘è¢«è®¿é—®çš„å…ƒç´ ï¼Œè¢« HashMap çš„ put æ–¹æ³•æ‰€è°ƒç”¨
void afterNodeInsertion(boolean evict) { 
    // å¾—åˆ°å…ƒç´ å¤´èŠ‚ç‚¹
    LinkedHashMap.Entry<K,V> first;
    // removeEldestEntry æ¥æ§åˆ¶åˆ é™¤ç­–ç•¥ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå¹¶ä¸”åˆ é™¤ç­–ç•¥å…è®¸åˆ é™¤çš„æƒ…å†µä¸‹ï¼Œåˆ é™¤å¤´èŠ‚ç‚¹
    if (evict && (first = head) != null && removeEldestEntry(first)) {
        K key = first.key;
        // removeNode åˆ é™¤å¤´èŠ‚ç‚¹
        removeNode(hash(key), key, null, false, true);
    }
}
```

## 3 å°ç»“

LinkedHashMap æä¾›äº†ä¸¤ä¸ªå¾ˆæœ‰æ„æ€çš„åŠŸèƒ½ï¼šæŒ‰ç…§æ’å…¥é¡ºåºè®¿é—®å’Œåˆ é™¤æœ€å°‘è®¿é—®å…ƒç´ ç­–ç•¥ï¼Œç®€å•åœ°é€šè¿‡é“¾è¡¨çš„ç»“æ„å°±å®ç°äº†ï¼Œè®¾è®¡å¾—éå¸¸å·§å¦™ã€‚